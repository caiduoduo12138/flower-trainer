import{i as K,L as Q}from"./echarts.b5e81855.js";import{n as T}from"./train.b37248da.js";import{c as U,Y as X,_ as ee}from"./index.0f5ebb0a.js";import{l as te,r as u,a as _,e as N,N as le,aa as ae,m as S,q as P,t as k,J as re,H as oe,D as q,E as Y,L as D,u as H,y as se,n as ne}from"./vue.4dfaac09.js";const ie={class:"flex-1 min-h-0 relative bg-[#131313]"},ue={class:"bg-[#000] rounded-lg h-full relative group"},ce={key:0,class:"absolute inset-0 flex items-center justify-center text-sm text-[#878787]"},ve=["title"],pe=ee(te({__name:"loss",props:{exp_name:{type:String,required:!0},has_running_task:{type:Boolean,default:!1}},setup(J,{expose:V}){const d=J,b=u(null);let r=null,v=null,f=0;const p=u("loading"),c=u({}),L=u([]),m=u({}),y=u(!1),z=u(!1),C=u(!0),B=u(90),g=u(!1);_(()=>[{key:"showSmoothed",label:"Smoothed",value:C.value},{key:"showRaw",label:"Raw",value:z.value},{key:"useLogScale",label:"Log Y",value:y.value}]),_(()=>{var n;if(p.value==="loading")return"Loading...";if(p.value==="refreshing")return"Refreshing...";if(p.value==="error")return"Error";const e=((n=Object.values(c.value)[0])==null?void 0:n.length)||0;return e>0?`${e.toLocaleString()} steps`:"No data yet"});const W=_(()=>Object.keys(c.value).length>0&&Object.values(c.value).some(e=>e.length>0));function I(e){return Math.max(0,Math.min(1,e))}const M=["rgba(96,165,250,1)","rgba(52,211,153,1)","rgba(167,139,250,1)","rgba(251,191,36,1)","rgba(244,114,182,1)","rgba(248,113,113,1)","rgba(129,140,248,1)","rgba(129,140,248,1)"];function Z(e){return M[function(n,o){let s=2166136261;for(let a=0;a<n.length;a++)s^=n.charCodeAt(a),s=Math.imul(s,16777619);return Math.abs(s)%o}(e,M.length)]}const j=()=>{r==null||r.resize()},A=_(()=>{const e=1-.98*I(B.value/100),n={};return L.value.forEach(o=>{if(m.value[o]===!1)return;const s=c.value[o]||[],a=y.value?s.filter(t=>t.value>0):s,l=function(t,i){if(t.length===0)return[];const R=I(i),E=new Array(t.length);let w=t[0].value;E[0]={step:t[0].step,value:w};for(let h=1;h<t.length;h++)w=R*t[h].value+(1-R)*w,E[h]={step:t[h].step,value:w};return E}(a,e);n[o]={raw:a,smooth:l}}),n}),F=()=>{if(!r)return;const e=[],n=Object.keys(A.value);let o=0;n.forEach(a=>{const l=Z(a),t=A.value[a];if(t.raw.length>0){const i=t.raw[t.raw.length-1].step;i>o&&(o=i)}z.value&&e.push({name:`${a} (raw)`,type:"line",smooth:!1,showSymbol:!1,symbol:"circle",symbolSize:6,lineStyle:{width:1,color:l.replace("1)","0.3)"),type:"solid"},itemStyle:{color:l},data:t.raw.map(i=>[i.step,i.value]),z:1}),C.value&&e.push({name:a,type:"line",smooth:!0,showSymbol:!1,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:l},itemStyle:{color:l},areaStyle:{color:new Q(0,0,0,1,[{offset:0,color:l.replace("1)","0.2)")},{offset:1,color:l.replace("1)","0.01)")}])},data:t.smooth.map(i=>[i.step,i.value]),z:2})});const s={backgroundColor:"transparent",tooltip:{trigger:"axis",axisPointer:{type:"none"},backgroundColor:"rgba(17,24,39,0.96)",borderColor:"rgba(31,41,55,1)",textStyle:{color:"#fff"},formatter:a=>{if(!a.length)return"";let l=`<div>Step ${a[0].axisValue}</div>`;return a.forEach(t=>{const i=typeof t.value[1]=="number"?t.value[1].toPrecision(4):t.value[1];l+=`<div style="color:${t.color}">${t.seriesName}: ${i}</div>`}),l}},grid:{top:40,left:10,right:20,bottom:40,containLabel:!0},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"filter"},{type:"slider",xAxisIndex:0,filterMode:"filter",height:15,bottom:10,borderColor:"transparent",backgroundColor:"#1C1B20",fillerColor:"rgba(153, 104, 255, 0.2)",handleStyle:{color:"#9968FF"},textStyle:{color:"#878787"},brushSelect:!1}],xAxis:{type:"value",scale:!0,max:o>0?o:void 0,splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(255,255,255,0.15)"}},axisLabel:{color:"rgba(255,255,255,0.55)",hideOverlap:!0},splitNumber:8,minInterval:1},yAxis:{type:y.value?"log":"value",scale:!0,splitLine:{lineStyle:{color:"rgba(255,255,255,0.06)",type:"dashed"}},axisLine:{lineStyle:{color:"rgba(255,255,255,0.15)"}},axisLabel:{color:"rgba(255,255,255,0.55)"}},animation:!1,series:e.length?e:[{type:"line",data:[]}]};r.setOption(s,{notMerge:!0})},G=async()=>{g.value=!g.value,await ne(),r==null||r.resize()},$=async()=>{if(d.exp_name){f===0&&(p.value="loading");try{const e=await T({exp_name:d.exp_name,since_step:f});if(p.value="success",e.data&&e.data.length>0){const n=e.data;let o=f;n.forEach(s=>{const a=s.step!==void 0?s.step:s.x;a!==void 0&&(a>=o&&(o=a+1),Object.keys(s).forEach(l=>{if(l==="step"||l==="epoch"||l==="timestamp")return;const t=s[l];typeof t=="number"&&(c.value[l]||(c.value[l]=[],L.value.push(l),m.value[l]===void 0&&(m.value[l]=!0)),c.value[l].push({step:a,value:t}))}))}),f=o,F()}else console.log(d.has_running_task),!d.has_running_task&&e.data.length==0&&v&&(clearInterval(v),v=null)}catch(e){console.error("Fetch error:",e),p.value="error"}}},O=()=>{x(),$(),v=setInterval($,5e3)},x=()=>{v&&(clearInterval(v),v=null)};return N(()=>d.exp_name,e=>{e?(c.value={},L.value=[],f=0,O()):x()}),N([B,C,z,y,m],()=>{F()},{deep:!0}),V({init:()=>{(()=>{if(b.value){r&&r.dispose(),r=K(b.value);const e=new ResizeObserver(()=>{r==null||r.resize()});e.observe(b.value),r.__resizeObserver=e,window.addEventListener("resize",j),F()}})(),d.exp_name&&O()},stopPolling:x}),le(()=>{x(),window.removeEventListener("resize",j),r&&(r.__resizeObserver&&r.__resizeObserver.disconnect(),r.dispose())}),(e,n)=>{const o=ae("el-icon");return S(),P("div",{class:se(["flex flex-col bg-[#1C1B20] overflow-hidden transition-all duration-300",g.value?"fixed inset-0 z-[9999] w-screen h-screen rounded-none":"h-full rounded-[10px]"])},[k("div",ie,[k("div",ue,[k("div",{ref_key:"chartRef",ref:b,class:"w-full h-full"},null,512),W.value?oe("",!0):(S(),P("div",ce,re(p.value==="error"?"Failed to load loss logs.":"Waiting for loss points..."),1)),k("button",{onClick:G,class:"absolute top-2 right-2 px-2 py-1 bg-[#1C1B20]/80 hover:bg-[#9968FF] text-[#FBFBFB] rounded-md border border-[#333] transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100",title:g.value?"Exit Fullscreen":"Fullscreen"},[g.value?(S(),q(o,{key:0,class:"relative top-[2px]"},{default:Y(()=>[D(H(U))]),_:1})):(S(),q(o,{key:1,class:"relative top-[2px]"},{default:Y(()=>[D(H(X))]),_:1}))],8,ve)])])],2)}}}),[["__scopeId","data-v-30922e9a"]]);export{pe as default};
