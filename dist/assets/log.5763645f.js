import{S as i}from"./index.0f5ebb0a.js";import{l as r,R as w,r as c,a as m,h as O,N as j,m as R,q as d}from"./vue.4dfaac09.js";const f=r({name:"global-websocket"}),y=r({...f,props:{uri:{type:String}},emits:["rollback"],setup(l,{emit:b}){const g=b,p=l,e=w({webSocket:c(),lockReconnect:!1,maxReconnect:6,reconnectTime:0,heartbeat:{interval:3e4,timeout:6e4,pingTimeoutObj:c(),pongTimeoutObj:c(),pingMessage:JSON.stringify({type:"ping"})}});m(()=>i.getToken()),m(()=>i.getTenant()),O(()=>{a()}),j(()=>{e.webSocket.close(),s(e.heartbeat)});const a=()=>{let o=`wss://${p.uri}`;e.webSocket=new WebSocket(o),e.webSocket.onopen=u,e.webSocket.onerror=T,e.webSocket.onmessage=S,e.webSocket.onclose=k},n=()=>{e.lockReconnect||e.maxReconnect!==-1&&e.reconnectTime>e.maxReconnect||(e.lockReconnect=!0,setTimeout(()=>{e.reconnectTime++,a(),e.lockReconnect=!1},5e3))},s=o=>{o.pingTimeoutObj&&clearTimeout(o.pingTimeoutObj),o.pongTimeoutObj&&clearTimeout(o.pongTimeoutObj)},u=()=>{console.log("\u8FDE\u63A5\u6210\u529F"),(()=>{const o=e.webSocket,t=e.heartbeat;s(t),t.pingTimeoutObj=setTimeout(()=>{console.log(o.readyState),o.readyState===1?(o.send(t.pingMessage),t.pongTimeoutObj=setTimeout(()=>{o.close()},t.timeout)):(console.log("startHeartbeat"),n())},t.interval)})()},T=()=>{console.log("onError"),n()},k=o=>{n()},S=o=>{const t=o.data;typeof t!="string"||t.indexOf("pong")>0||g("rollback",t)};return(o,t)=>(R(),d("div"))}});export{y as default};
