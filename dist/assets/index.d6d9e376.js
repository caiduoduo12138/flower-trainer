import{S as m,o as j,aV as R}from"./index.0f5ebb0a.js";import{l,R as f,r as c,a as g,h as v,N as h,m as x,q as y}from"./vue.4dfaac09.js";const N=l({name:"global-websocket"}),$=l({...N,props:{uri:{type:String}},emits:["rollback"],setup(b,{emit:p}){const u=p,T=b,e=f({webSocket:c(),lockReconnect:!1,maxReconnect:6,reconnectTime:0,heartbeat:{interval:3e4,timeout:1e4,pingTimeoutObj:c(),pongTimeoutObj:c(),pingMessage:JSON.stringify({type:"ping"})}}),a=g(()=>m.getToken()),k=g(()=>m.getTenant());v(()=>{i()}),h(()=>{e.webSocket.close(),s(e.heartbeat)});const i=()=>{let t=`ws://${window.location.host}/api${j.adaptationUrl(T.uri)}?access_token=${a.value}&TENANT-ID=${k.value}`;e.webSocket=new WebSocket(t),e.webSocket.onopen=w,e.webSocket.onerror=S,e.webSocket.onmessage=d,e.webSocket.onclose=O},n=()=>{a&&(e.lockReconnect||e.maxReconnect!==-1&&e.reconnectTime>e.maxReconnect||(e.lockReconnect=!0,setTimeout(()=>{e.reconnectTime++,i(),e.lockReconnect=!1},5e3)))},s=t=>{t.pingTimeoutObj&&clearTimeout(t.pingTimeoutObj),t.pongTimeoutObj&&clearTimeout(t.pongTimeoutObj)},r=()=>{const t=e.webSocket,o=e.heartbeat;s(o),o.pingTimeoutObj=setTimeout(()=>{t.readyState===1?(t.send(o.pingMessage),o.pongTimeoutObj=setTimeout(()=>{t.close()},o.timeout)):n()},o.interval)},w=()=>{r(),e.reconnectTime=0},S=()=>{n()},O=()=>{n()},d=t=>{r();const o=t.data;o.indexOf("pong")>0||(R.warning({title:"\u6D88\u606F\u63D0\u9192",dangerouslyUseHTMLString:!0,message:o+"\u8BF7\u53CA\u65F6\u5904\u7406",offset:60}),u("rollback",o))};return(t,o)=>(x(),y("div"))}});export{$ as default};
